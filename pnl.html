<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Investment & Earnings Tracker</title>
  <!-- Materialize CSS for Material UI style -->
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"
    rel="stylesheet"
  />
  <!-- Chart.js for cumulative earnings chart -->
  <script
    src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"
    defer
  ></script>
  <style>
    body {
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 780px;
      margin: auto;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    }
    h4 {
      margin-bottom: 30px;
    }
    #message {
      margin-top: 15px;
      min-height: 24px;
      color: green;
    }
    .scroll-table {
      max-height: 250px;
      overflow-y: auto;
      display: block;
    }
    table.striped span {
      font-size: 1.05em;
    }
    /* Custom color row striping and highlights */
    .custom-table thead {
      background: linear-gradient(to right, #1976d2, #86b8f7);
      color: #fff;
    }
    .custom-table tbody tr:nth-child(even) {
      background-color: #f1fafe;
    }
    .custom-table tbody tr:nth-child(odd) {
      background-color: #e3edf6;
    }
    .custom-table tbody tr:hover {
      background-color: #bdf6d1 !important;
    }
    .total-amount-box {
      display: inline-block;
      margin-left: 18px;
      font-weight: bold;
      font-size: 1.28em;
      vertical-align: middle;
      padding: 2px 18px;
      border-radius: 5px;
      background: #f8f8f8;
      box-shadow: 0 1px 5px #aaa3;
      letter-spacing: 0.5px;
      transition: background 0.2s, color 0.2s;
    }
    .total-profit {
      color: #258c25;
      background: #def9df;
      border: 1.5px solid #b1e5b3;
    }
    .total-loss {
      color: #c62828;
      background: #fdeaea;
      border: 1.5px solid #edb3b3;
    }
    .import-export-row {
      margin-top: 14px;
      margin-bottom: 6px;
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      align-items: center;
    }
    .import-label {
      padding: 7px 16px;
      color: #1565c0;
      border-radius: 4px;
      border: 1px solid #bbdefb;
      background: #e3f2fd;
      margin-right: 7px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.97em;
      transition: background 0.2s, color 0.2s;
      display: inline-block;
    }
    .import-label:hover {
      background: #bbdefb;
      color: #0a47a1;
    }
    #importFile {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h4 class="center-align">Investment & Earnings Tracker</h4>
    <!-- Capital Investment Form -->
    <div class="row">
      <div class="input-field col s12 m8">
        <input id="capitalInvestment" type="number" min="0" step="0.01" />
        <label for="capitalInvestment">Capital Investment</label>
      </div>
      <div class="col s12 m4" style="padding-top: 20px;">
        <button id="saveCapitalBtn" class="btn waves-effect waves-light full-width">
          Save Capital
        </button>
      </div>
    </div>
    <!-- Daily Earnings Form -->
    <div class="row">
      <div class="input-field col s12 m4">
        <input id="earningsDate" type="date" />
        <label for="earningsDate" class="active"></label>
      </div>
      <div class="input-field col s12 m5">
        <input id="dailyEarnings" type="number" step="0.01" />
        <label for="dailyEarnings">Daily Earnings</label>
      </div>
      <div class="col s12 m3" style="padding-top: 20px;">
        <button id="saveEarningsBtn" class="btn waves-effect waves-light full-width">
          Save Earnings
        </button>
      </div>
    </div>
    <!-- IMPORT / EXPORT & HARD RESET BUTTONS -->
    <div class="import-export-row">
      <button id="exportBtn" class="btn teal accent-4">EXPORT</button>
      <label for="importFile" class="import-label">IMPORT</label>
      <input type="file" id="importFile" accept=".json,application/json" />
      <button id="hardResetBtn" class="btn red darken-2">HARD RESET</button>
    </div>
    <div id="message"></div>

    <h5 style="margin-top:32px;">Daily Earnings Table</h5>
    <div class="scroll-table">
      <table class="striped highlight custom-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Earnings</th>
          </tr>
        </thead>
        <tbody id="earningsTableBody"></tbody>
      </table>
    </div>

    <div style="display:flex; align-items:center; justify-content: space-between; margin-top:32px;">
      <h5 style="margin-bottom: 0;">
        Cumulative Earnings This Month
      </h5>
      <span id="totalEarningsMonth" class="total-amount-box">₹ --</span>
    </div>
    <canvas id="cumulativeChart" height="300"></canvas>
  </div>
  <script>
    // Local Storage Key
    const STORAGE_KEY = "investmentEarningsData";
    let data = { capitalInvestment: 0, earnings: {} };

    const capitalInput = document.getElementById("capitalInvestment");
    const earningsDateInput = document.getElementById("earningsDate");
    const dailyEarningsInput = document.getElementById("dailyEarnings");
    const messageDiv = document.getElementById("message");
    const saveCapitalBtn = document.getElementById("saveCapitalBtn");
    const saveEarningsBtn = document.getElementById("saveEarningsBtn");
    const hardResetBtn = document.getElementById("hardResetBtn");
    const tableBody = document.getElementById("earningsTableBody");
    const ctxCumulative = document.getElementById("cumulativeChart").getContext("2d");
    const totalEarningsMonthBox = document.getElementById("totalEarningsMonth");
    const exportBtn = document.getElementById("exportBtn");
    const importFile = document.getElementById("importFile");
    let cumulativeChart;

    // Load saved data from Local Storage
    function loadData() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        data = JSON.parse(stored);
        capitalInput.value = data.capitalInvestment;
        M.updateTextFields();
      }
      if (!earningsDateInput.value) {
        earningsDateInput.value = new Date().toISOString().slice(0, 10);
      }
    }

    // Save to Local Storage
    function saveData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // Show message
    function showMessage(msg, color="green") {
      messageDiv.textContent = msg;
      messageDiv.style.color = color;
      setTimeout(() => {
        if (messageDiv.textContent === msg) messageDiv.textContent = "";
      }, 4000);
    }

    // Save capital investment
    saveCapitalBtn.addEventListener("click", () => {
      const val = parseFloat(capitalInput.value);
      if (isNaN(val) || val < 0) {
        showMessage("Please enter a valid non-negative capital investment.", "red");
        return;
      }
      data.capitalInvestment = val;
      saveData();
      showMessage("Capital investment saved.");
      updateCumulativeChart();
    });

    // Save daily earnings
    saveEarningsBtn.addEventListener("click", () => {
      const date = earningsDateInput.value;
      const val = parseFloat(dailyEarningsInput.value);
      if (!date) {
        showMessage("Please select a valid date.", "red");
        return;
      }
      if (isNaN(val)) {
        showMessage("Please enter a valid number for daily earnings.", "red");
        return;
      }
      data.earnings[date] = val;
      // Keep only last 30 entries (by date)
      const keys = Object.keys(data.earnings).sort();
      if (keys.length > 30) {
        const keysToRemove = keys.slice(0, keys.length - 30);
        keysToRemove.forEach((k) => delete data.earnings[k]);
      }
      saveData();
      showMessage(`Earnings for ${date} saved.`);
      dailyEarningsInput.value = "";
      updateTable();
      updateCumulativeChart();
    });

    // Export button - Download JSON of data
    exportBtn.addEventListener("click", () => {
      const jsonStr = JSON.stringify(data, null, 2);
      const blob = new Blob([jsonStr], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      const filename = "investment_earnings_" + (new Date().toISOString().replace(/:/g, "-").slice(0,16)) + ".json";
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        document.body.removeChild(link);
      }, 1000);
      showMessage("Data exported as JSON file.");
    });

    // Import button - Select JSON and load
    importFile.addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const imported = JSON.parse(e.target.result);
          if (
            typeof imported === "object"
            && imported.hasOwnProperty("capitalInvestment")
            && imported.hasOwnProperty("earnings")
            && typeof imported.earnings === "object"
          ) {
            data = imported;
            saveData();
            capitalInput.value = data.capitalInvestment;
            M.updateTextFields();
            updateTable();
            updateCumulativeChart();
            showMessage("Import successful.");
          } else {
            showMessage("Invalid JSON file structure.", "red");
          }
        } catch {
          showMessage("Failed to parse JSON file.", "red");
        }
      };
      reader.readAsText(file);
      // Reset so importFile can trigger again if same file selected next time
      event.target.value = "";
    });

    // Hard reset
    hardResetBtn.addEventListener("click", () => {
      if (
        confirm(
          "Are you sure you want to clear all data and start fresh? This action cannot be undone."
        )
      ) {
        localStorage.removeItem(STORAGE_KEY);
        data = { capitalInvestment: 0, earnings: {} };
        capitalInput.value = "";
        earningsDateInput.value = new Date().toISOString().slice(0, 10);
        dailyEarningsInput.value = "";
        M.updateTextFields();
        showMessage("All data cleared. You can start fresh.");
        updateTable();
        updateCumulativeChart();
      }
    });

    // Table of earnings
    function updateTable() {
      // Sort dates descending (latest first)
      const entries = Object.entries(data.earnings).sort((a, b) => b[0].localeCompare(a[0]));
      tableBody.innerHTML = entries
        .map(([date, val]) => {
          let rowColor = '';
          if (val > 0) rowColor = ' style="color:#258c25;font-weight:bold;"';
          if (val < 0) rowColor = ' style="color:#c62828;font-weight:bold;"';
          return `<tr>
                    <td><span>${date}</span></td>
                    <td${rowColor}><span>${val.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></td>
                  </tr>`;
      })
      .join("");
      // If empty, add a placeholder row
      if (!entries.length) {
        tableBody.innerHTML = `<tr><td colspan="2" class="center-align">No data available.</td></tr>`;
      }
    }

    // Cumulative earnings chart & total for current month
    function updateCumulativeChart() {
      const now = new Date();
      const thisMonth = now.toISOString().slice(0, 7);
      // Filter earnings to current month and sort by date
      const earningsThisMonth = Object.entries(data.earnings)
        .filter(([date]) => date.startsWith(thisMonth))
        .sort((a, b) => a[0].localeCompare(b[0])); // sort ascending

      const labels = [];
      const cumulativeData = [];
      let total = 0;
      earningsThisMonth.forEach(([date, val]) => {
        total += Number(val);
        labels.push(date);
        cumulativeData.push(total);
      });

      // Update total box & color
      let cap = Number(data.capitalInvestment || 0);
      let difference = total - cap;
      if (labels.length === 0) {
        totalEarningsMonthBox.textContent = "₹ --";
        totalEarningsMonthBox.className = "total-amount-box";
      } else {
        let rupee = "₹";
        totalEarningsMonthBox.textContent = rupee + " " + total.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
        if (difference >= 0) {
          totalEarningsMonthBox.className = "total-amount-box total-profit";
        } else {
          totalEarningsMonthBox.className = "total-amount-box total-loss";
        }
      }

      // Chart.js config
      const config = {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Total Earnings So Far",
              data: cumulativeData,
              borderColor: "#43a047",
              backgroundColor: "rgba(67, 160, 71, 0.2)",
              tension: 0.35,
              fill: true,
              pointRadius: 4,
            },
          ],
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: { display: true, text: "Date" },
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "Cumulative Sum" },
            },
          },
          plugins: {
            legend: {
              position: "top",
              labels: { boxWidth: 15, boxHeight: 15 },
            },
            tooltip: {
              mode: "index",
              intersect: false,
            },
          },
          animation: {
            duration: 700,
            easing: "easeInOutQuad",
          },
        },
      };
      // Render or update
      if (cumulativeChart) {
        cumulativeChart.data = config.data;
        cumulativeChart.options = config.options;
        cumulativeChart.update();
      } else {
        cumulativeChart = new Chart(ctxCumulative, config);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadData();
      updateTable();
      updateCumulativeChart();
      M.updateTextFields();
    });
  </script>
  <!-- Materialize JS for interactivity -->
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"
    defer
  ></script>
</body>
</html>
